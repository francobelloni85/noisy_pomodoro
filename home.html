
<!doctype html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Pomodoro with noise detector</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-GLhlTQ8iRABdZLl6O3oVMWSktQOp6b7In1Zl3/Jr59b6EGGoI1aFkw7cmDA6j6gD" crossorigin="anonymous">

    <style>
        #volume-visualizer {
            --volume: 0%;
            position: relative;
            width: 200px;
            height: 20px;
            margin: 50px;
            background-color: #DDD;
        }

            #volume-visualizer::before {
                content: '';
                position: absolute;
                top: 0;
                bottom: 0;
                left: 0;
                width: var(--volume);
                background-color: green;
                transition: width 100ms linear;
            }


        #display_timer {
            font-family: 'Courier New';
            font-size: 36px;
            color: green;
            border: 1px solid green;
        }

        td {
            padding: 5px;
        }

        .invalid {
            border: 1px solid red;
        }
    </style>
</head>

<body>

    <div class="container-fluid">

        <div class="row mt-2">
            <div class="col-12">
                <div class="accordion" id="accordionPanelsStayOpenExample">
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingOne">
                            <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseOne" aria-expanded="true" aria-controls="panelsStayOpen-collapseOne">
                                <strong>Pomodoro with noise detector</strong>
                            </button>
                        </h2>
                        <div id="panelsStayOpen-collapseOne" class="accordion-collapse collapse show" aria-labelledby="panelsStayOpen-headingOne">
                            <div class="accordion-body">
                                <div class="row mt-2">
                                    <div class="col-4">
                                        <h3>Noise</h3>
                                        <div id="volume-visualizer"></div>
                                    </div>
                                    <div class="col-2">
                                        <h3>Value</h3>
                                        <p id="noise_value">76</p>
                                    </div>
                                    <div class="col-2">
                                        <h3>Strike</h3>
                                        <p>0</p>
                                    </div>
                                    <div class="col-2">
                                        <h3>Mode</h3>
                                        <p>Lesson time</p>
                                    </div>
                                    <div class="col-2">
                                        <h3>Timer</h3>
                                        <p id="display_timer">0m 0s</p>
                                    </div>
                                </div>
                                <button id="start">Start</button>
                                <button id="stop">Stop</button>
                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingTwo">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseTwo" aria-expanded="false" aria-controls="panelsStayOpen-collapseTwo">
                                Settings
                            </button>
                        </h2>
                        <div id="panelsStayOpen-collapseTwo" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingTwo">
                            <div class="accordion-body">


                                <table width="100%">
                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtLessonTime" class="form-label">Lesson time (minutes)</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtLessonTime" name="txtLessonTime" placeholder="25">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtBreakTime" class="form-label">Break time (minutes)</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtBreakTime" name="txtBreakTime" placeholder="5">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtNoiseThresholdDecibelLesson" class="form-label">Noise threshold (decibel) for lesson</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtNoiseThresholdDecibelLesson" name="txtNoiseThresholdDecibelLesson" placeholder="50">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtNoiseThresholdTimeLesson" class="form-label">Noise threshold (seconds) for lesson</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtNoiseThresholdTimeLesson" name="txtNoiseThresholdTimeLesson" placeholder="2">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtNoiseThresholdDecibelBreak" class="form-label">Noise threshold (decibel) for break</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtNoiseThresholdDecibelBreak" name="txtNoiseThresholdDecibelBreak" placeholder="70">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtNoiseThresholdTimeBreck" class="form-label">Noise threshold (seconds) for break</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtNoiseThresholdTimeBreck" name="txtNoiseThresholdTimeBreck" placeholder="3">
                                        </td>
                                    </tr>

                                    <tr>
                                        <td style="width:50%">
                                            <label for="txtEnableAudio" class="form-label">Enable audio "Shhh" (ON = 1, OFF = 0)</label>
                                        </td>
                                        <td>
                                            <input type="text" class="form-control" id="txtEnableAudio" name="txtEnableAudio" placeholder="1">
                                        </td>
                                    </tr>

                                </table>



                            </div>
                        </div>
                    </div>
                    <div class="accordion-item">
                        <h2 class="accordion-header" id="panelsStayOpen-headingThree">
                            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#panelsStayOpen-collapseThree" aria-expanded="false" aria-controls="panelsStayOpen-collapseThree">
                                Statistics
                            </button>
                        </h2>
                        <div id="panelsStayOpen-collapseThree" class="accordion-collapse collapse" aria-labelledby="panelsStayOpen-headingThree">
                            <div class="accordion-body">
                                <strong>This is the third item's accordion body.</strong> It is hidden by default, until the collapse plugin adds the appropriate classes that we use to style each element. These classes control the overall appearance, as well as the showing and hiding via CSS transitions. You can modify any of this with custom CSS or overriding our default variables. It's also worth noting that just about any HTML can go within the <code>.accordion-body</code>, though the transition does limit overflow.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js" integrity="sha384-oBqDVmMz9ATKxIep9tiCxS/Z9fNfEXiDAYTujMAeBAsjFuCZSmKbSSUnQlmh/jp3" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js" integrity="sha384-mQ93GR66B00ZXjt0YO5KlohRA5SY2XofN4zfuZxLkoj1gXtW8ANNCe9d5Y3eG5eD" crossorigin="anonymous"></script>

    <!--SETTINGS-->
    <script>

        const settings = {
            lesson_time: 25,
            break_time: 5,
            noise_threshold_decibel_lesson: 50,
            noise_threshold_seconds_lesson: 2,
            noise_threshold_decibel_break: 70,
            noise_threshold_seconds_break: 3,
            enable_audio: 1,
        };

        /* event listener */
        document.getElementsByName("txtLessonTime")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtBreakTime")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtNoiseThresholdDecibelLesson")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtNoiseThresholdTimeLesson")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtNoiseThresholdDecibelBreak")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtNoiseThresholdTimeBreck")[0].addEventListener('change', ChangeSettings);
        document.getElementsByName("txtEnableAudio")[0].addEventListener('change', ChangeSettings);

        /* function */

        function ChangeSettings() {
            console.log('Horray! Someone wrote "' + this.value + " " + this.id + '"!');
            const newValue = parseInt(this.value);

            if (isNaN(newValue)) {
                //alert("Input is not a number!");
                document.getElementById(this.id).classList.add("invalid");
                return;
            }

            switch (this.id) {
                case "txtLessonTime":
                    settings.lesson_time = newValue;
                    document.getElementById("display_timer").innerHTML = settings.lesson_time + "m " + "0s ";
                    break;

                case "txtBreakTime":
                    settings.break_time = newValue;
                    break;

                case "txtNoiseThresholdDecibelLesson":
                    settings.noise_threshold_decibel_lesson = newValue;
                    break;

                case "txtNoiseThresholdTimeLesson":
                    settings.noise_threshold_seconds_lesson = newValue;
                    break;

                case "txtNoiseThresholdDecibelBreak":
                    settings.noise_threshold_decibel_break = newValue;
                    break;

                case "txtNoiseThresholdTimeBreck":
                    settings.noise_threshold_seconds_break = newValue;
                    break;

                case "txtEnableAudio":
                    settings.enable_audio = newValue;
                    break;

            }

            console.log("Setting have been changed");
            console.log(settings);

        }


    </script>

    <!--VOLUME DETECTOR-->
    <script>

        let countDownDate = new Date("Jan 5, 2024 15:37:25").getTime();
        let countdownTimer = null;

        (async () => {
            let volumeCallback = null;
            let volumeInterval = null;
            const volumeVisualizer = document.getElementById('volume-visualizer');
            const startButton = document.getElementById('start');
            const stopButton = document.getElementById('stop');
            const noiseValue = document.getElementById('noise_value');

            // Initialize
            try {

                const audioStream = await navigator.mediaDevices.getUserMedia({
                    audio: {
                        echoCancellation: true
                    }
                });

                const audioContext = new AudioContext();
                const audioSource = audioContext.createMediaStreamSource(audioStream);
                const analyser = audioContext.createAnalyser();
                analyser.fftSize = 512;
                analyser.minDecibels = -127;
                analyser.maxDecibels = 0;
                analyser.smoothingTimeConstant = 0.4;
                audioSource.connect(analyser);

                const volumes = new Uint8Array(analyser.frequencyBinCount);

                volumeCallback = () => {
                    analyser.getByteFrequencyData(volumes);
                    let volumeSum = 0;
                    for (const volume of volumes)
                        volumeSum += volume;
                    const averageVolume = volumeSum / volumes.length;
                    noiseValue.innerText = parseInt(averageVolume);
                    // Value range: 127 = analyser.maxDecibels - analyser.minDecibels;
                    volumeVisualizer.style.setProperty('--volume', (averageVolume * 100 / 127) + '%');
                };

            } catch (e) {
                console.error('Failed to initialize volume visualizer, simulating instead...', e);
                // Simulation
                //TODO remove in production!
                let lastVolume = 50;
                volumeCallback = () => {
                    const volume = Math.min(Math.max(Math.random() * 100, 0.8 * lastVolume), 1.2 * lastVolume);
                    lastVolume = volume;
                    volumeVisualizer.style.setProperty('--volume', volume + '%');
                };
            }

            // Use
            startButton.addEventListener('click', () => {
                // Updating every 100ms (should be same as CSS transition speed)
                if (volumeCallback !== null && volumeInterval === null)
                    volumeInterval = setInterval(volumeCallback, 100);

                if (countdownTimer === null) {
                    // Update the count down every 1 second
                    countdownTimer = setInterval(UpdateClockCallBack, 1000);
                } else {
                    alert("Timer already set");
                }
            });

            stopButton.addEventListener('click', () => {

                if (volumeInterval !== null) {
                    clearInterval(volumeInterval);
                    volumeInterval = null;
                }

                if (countdownTimer !== null) {
                    clearInterval(countdownTimer);
                    countdownTimer = null;
                }

            });

        })();


    </script>


    <!--TIMER-->
    <script>
        // Set the date we're counting down to


        function UpdateClockCallBack() {

            // Get today's date and time
            var now = new Date().getTime();

            // Find the distance between now and the count down date
            var distance = countDownDate - now;

            // Time calculations for days, hours, minutes and seconds

            //var days = Math.floor(distance / (1000 * 60 * 60 * 24));
            //var hours = Math.floor((distance % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));

            var minutes = Math.floor((distance % (1000 * 60 * 60)) / (1000 * 60));
            var seconds = Math.floor((distance % (1000 * 60)) / 1000);

            // Display the result in the element with id="demo"
            document.getElementById("display_timer").innerHTML = minutes + "m " + seconds + "s ";


            // If the count down is finished, write some text
            if (distance < 0) {
                clearInterval(countdownTimer);
                document.getElementById("display_timer").innerHTML = "EXPIRED";
                countdownTimer = null;
            }


        }



    </script>





</body>
</html>

